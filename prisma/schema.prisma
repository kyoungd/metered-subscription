// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id          String   @id @default(cuid())
  clerkOrgId  String   @unique @map("clerk_org_id")
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       User[]
  subscriptions Subscription[]
  usageCounters UsageCounter[]
  usageRecords UsageRecord[]

  @@map("organizations")
}

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique @map("clerk_id")
  email     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@map("users")
}

model Subscription {
  id              String   @id @default(cuid())
  clerkOrgId      String   @map("clerk_org_id")
  stripeCustomerId String  @map("stripe_customer_id")
  stripeSubscriptionId String @unique @map("stripe_subscription_id")
  planCode        String   @map("plan_code")
  stripePriceId   String   @map("stripe_price_id")
  status          String   // active, trialing, canceled, past_due
  currentPeriodStart DateTime @map("current_period_start")
  currentPeriodEnd   DateTime @map("current_period_end")
  trialEndsAt      DateTime? @map("trial_ends_at")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  usageCounters  UsageCounter[]
  usageRecords   UsageRecord[]

  @@map("subscriptions")
}

model UsageCounter {
  id              String   @id @default(cuid())
  clerkOrgId      String   @map("clerk_org_id")
  periodKey       String   @map("period_key") // YYYY-MM format
  periodStart     DateTime @map("period_start")
  periodEnd       DateTime @map("period_end")
  metric          String   // 'api_call'
  included        Int      // quota from plan
  used            Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  usageRecords   UsageRecord[]

  @@unique([clerkOrgId, periodKey, metric])
  @@map("usage_counters")
}

model UsageRecord {
  id              String   @id @default(cuid())
  clerkOrgId      String   @map("clerk_org_id")
  metric          String
  value           Int
  occurredAt      DateTime @map("occurred_at")
  metadata        Json?    // for idempotency: {"request_id": "..."}
  createdAt       DateTime @default(now())

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  usageCounterId String
  usageCounter   UsageCounter @relation(fields: [usageCounterId], references: [id])

  @@map("usage_records")
}

model WebhookQueue {
  id        String   @id @default(cuid())
  eventId   String   @unique @map("event_id")
  eventType String   @map("event_type")
  processed Boolean  @default(false)
  payload   Json
  createdAt DateTime @default(now())
  processedAt DateTime? @map("processed_at")

  @@map("webhook_queue")
}

model DebugLog {
  id        String   @id @default(cuid())
  level     String   // info, warn, error
  message   String
  metadata  Json?
  createdAt DateTime @default(now())

  @@map("debug_logs")
}
