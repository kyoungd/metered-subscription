# Metered Subscriptions Platform

SaaS billing: monthly subscriptions with included usage, hard quota enforcement, trials, upgrades/downgrades. For API vendors (SMB/mid-market) needing fixed units + real-time limits—no overage billing.

## Workflow

1. **Plan**: Read code → Write todo (`tasks/todo.md`) → **GET APPROVAL**
2. **Check**: Search existing (reuse>create) → Check side effects → **DISCUSS**
3. **Code**: Work todos → Mark done → Minimal changes
4. **Update**: High-level summary (what/why)
5. **Review**: Add summary to todo.md

## Core Rules

- **No code without permission** - Discuss design first, get approval
- **Fixing bugs?** - Find source first, add logging if unknown
- **Simplest change wins** - Minimal code impact
- **Uncertain?** - Ask, don't assume
- **Reuse>Create** - Search before building

## Standard Operating Procedures

- **Design** - Available
- **Implmentation** - AI
- **Implementation Review** - AI: Interface/Schema Consistency, Event & Message Contracts, Adapter/SDK Usage, Error Envelope Integrity, Transaction & Atomicity, Idempotency, Time & Money Units, Logic Drift from Design, Security/PII Rules, Performance/ Await Safety
- **Code Review** - Human: always show the diff; user must review and explicitly accept code before commit.
- **Testing** - AI

## Existing Code (Reuse)

- Prisma: Organization, User, Subscription, UsageCounter, UsageRecord
- Envelope: `wrapSuccess(data)` / `wrapError(err)`
- Config: `.env` file

## Stack

Next.js, TS, Tailwind, shadcn/ui, Clerk, Prisma, PostgreSQL, Stripe, Redis, Node 22.13.1, sentry, Stigg

## SDK Rules

**ALWAYS use official SDKs. NEVER custom REST clients.**

**Before integration:**

1. Check official SDK in package.json
2. Verify package name + env vars from official docs
3. Use exact init patterns

**Installed:**

- Clerk: `@clerk/nextjs` (`clerkClient`, `auth()` from `/server`)
- Stripe: `stripe` (see `/lib/stripe.js`)
- Stigg: `@stigg/node-server-sdk` (`STIGG_SERVER_API_KEY`)
  https://docs.stigg.io/api-and-sdks/integration/frontend/nextjs

**Never:** Custom fetch wrappers, invented env names, manual API clients

### Code Boundaries

src/
├── app/ # Next.js app router (API routes, pages)
├── lib/ # Shared logic & clients (scaffolded core)
│ ├── scaffold/ # Global utility clients (Stripe, Stigg, Redis, etc.)
│ ├── db/ # Prisma client, migrations, repository functions
│ ├── services/ # Core domain logic per story/use-case
│ ├── jobs/ # Background jobs (cron or API-triggered)
│ ├── webhooks/ # Signature verification + queue intake
│ ├── billing/ # Stripe + Stigg orchestration logic
│ ├── quota/ # Real-time usage & quota enforcement
│ ├── entitlements/ # Read API + computation of plan allowances
│ ├── api/ # Shared API request/response schema (Zod)
│ ├── test/ # Reusable test helpers & mocks
│ └── utils/ # Pure utility functions (no side effects)
├── prisma/ # Schema + migrations
├── tests/ # Story-level Jest tests (integration)
│ ├── unit/ # unit testing
│ ├── integration/ # integration testing
│ ├── e2e/ # e2e testing
└── types/ # Global TS interfaces & enums
