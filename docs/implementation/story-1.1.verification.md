# Story 1.1 Verification Checklist

## Pre-Deployment Checklist

Before deploying Story 1.1 to production, complete the following verification steps:

---

## 1. Install Dependencies

```bash
# Install Jest and testing dependencies
npm install -D jest @types/jest ts-jest @testing-library/jest-dom @testing-library/react @testing-library/user-event jest-environment-jsdom
```

**Verification**: Check that all dependencies are installed without errors.

---

## 2. Type Checking

```bash
npm run type-check
```

**Expected**: No TypeScript errors.

**Verification**: ✅ All files compile successfully.

---

## 3. Linting

```bash
npm run lint
```

**Expected**: No linting errors.

**Verification**: ✅ All files pass linting rules.

---

## 4. Run Tests

### Run All Tests
```bash
npm test
```

**Expected**: All tests pass.

### Run Unit Tests Only
```bash
npm run test:unit
```

**Expected**: All unit tests pass.

### Run Integration Tests Only
```bash
npm run test:integration
```

**Expected**: All integration tests pass.

### Run Tests with Coverage
```bash
npm run test:coverage
```

**Expected**: High coverage for new files (>80%).

---

## 5. Database Setup

### Check Prisma Schema
```bash
npx prisma format
npx prisma validate
```

**Expected**: Schema is valid.

### Generate Prisma Client
```bash
npx prisma generate
```

**Expected**: Client generated successfully.

### Run Migrations (if needed)
```bash
npx prisma migrate dev --name add-organizations
```

**Expected**: Migration runs successfully.

---

## 6. Environment Variables

Verify all required environment variables are set:

```bash
# Required for Story 1.1
✅ DATABASE_URL
✅ NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
✅ CLERK_SECRET_KEY
✅ NEXTAUTH_SECRET
✅ NEXTAUTH_URL

# Not used in Story 1.1 but required by env schema
✅ STRIPE_SECRET_KEY
✅ NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
✅ STRIPE_WEBHOOK_SECRET
✅ STIGG_SERVER_API_KEY
```

---

## 7. Manual Testing

### Test Endpoint Manually

#### 1. Start Development Server
```bash
npm run dev
```

#### 2. Get Clerk Session Token
- Log in to your application via Clerk
- Open browser DevTools → Application → Cookies
- Copy the `__session` cookie value

#### 3. Test Happy Path
```bash
curl -X POST http://localhost:3000/api/orgs/create \
  -H "Authorization: Bearer <clerk_session_token>" \
  -H "x-request-id: test-req-123" \
  -H "x-correlation-id: test-corr-456" \
  -H "Content-Type: application/json" \
  -d '{}'
```

**Expected Response** (200):
```json
{
  "data": {
    "orgId": "clxy1234567890abcdef"
  },
  "correlationId": "test-corr-456"
}
```

#### 4. Test Unauthenticated
```bash
curl -X POST http://localhost:3000/api/orgs/create \
  -H "Content-Type: application/json" \
  -d '{}'
```

**Expected Response** (401):
```json
{
  "error": {
    "code": "UNAUTHORIZED",
    "message": "Authentication required"
  },
  "correlationId": "<auto-generated>"
}
```

#### 5. Test Missing Headers
```bash
curl -X POST http://localhost:3000/api/orgs/create \
  -H "Authorization: Bearer <clerk_session_token>" \
  -H "Content-Type: application/json" \
  -d '{}'
```

**Expected**: Response includes auto-generated `correlationId`.

#### 6. Test Idempotency
Run the same request twice with the same `x-request-id`:

```bash
# First request
curl -X POST http://localhost:3000/api/orgs/create \
  -H "Authorization: Bearer <clerk_session_token>" \
  -H "x-request-id: idempotent-test-123" \
  -H "Content-Type: application/json" \
  -d '{}'

# Second request (same x-request-id)
curl -X POST http://localhost:3000/api/orgs/create \
  -H "Authorization: Bearer <clerk_session_token>" \
  -H "x-request-id: idempotent-test-123" \
  -H "Content-Type: application/json" \
  -d '{}'
```

**Expected**: Both requests return the same `orgId`.

---

## 8. Database Verification

### Check Organization Created
```sql
-- Connect to your database
SELECT * FROM organizations ORDER BY created_at DESC LIMIT 5;
```

**Expected**: See newly created organization records with:
- `id` (internal CUID)
- `clerk_org_id` (from Clerk session)
- `name` (default: "Organization {clerk_org_id}")
- `created_at` (UTC timestamp)
- `updated_at` (UTC timestamp)

### Verify Idempotency
```sql
-- Check for duplicate clerk_org_id
SELECT clerk_org_id, COUNT(*) as count
FROM organizations
GROUP BY clerk_org_id
HAVING COUNT(*) > 1;
```

**Expected**: No duplicates (count should be 0 rows).

---

## 9. Log Verification

### Check Logs for PII Redaction

1. Add test data with PII:
```bash
# Logs should redact email, name, tokens
```

2. Check application logs:
```bash
# Look for structured JSON logs
tail -f logs/app.log | grep "Creating organization"
```

**Expected**: 
- Logs are in JSON format
- PII fields are `[REDACTED]`
- `request_id` and `correlation_id` are present
- `orgId` is present (not PII)

---

## 10. Code Quality Checks

### Check for Console Logs
```bash
grep -r "console.log" src/lib src/app --exclude-dir=node_modules
```

**Expected**: No `console.log` statements (use `logger` instead).

### Check for TODO Comments
```bash
grep -r "TODO" src/lib src/app --exclude-dir=node_modules
```

**Expected**: No critical TODOs remaining.

### Check for Hardcoded Values
```bash
grep -r "hardcoded\|FIXME\|HACK" src/lib src/app --exclude-dir=node_modules
```

**Expected**: No hardcoded values or temporary hacks.

---

## 11. Documentation Review

### Verify Documentation Files Exist
- ✅ `docs/api.md` - API documentation
- ✅ `docs/implementation/story-1.1.context.json` - Implementation context
- ✅ `docs/implementation/story-1.1.summary.md` - Implementation summary
- ✅ `docs/implementation/story-1.1.quick-reference.md` - Quick reference
- ✅ `docs/implementation/story-1.1.verification.md` - This file

### Review API Documentation
```bash
cat docs/api.md
```

**Expected**: Complete documentation for `POST /api/orgs/create`.

---

## 12. Security Review

### Check Authentication
- ✅ All endpoints require Clerk authentication
- ✅ Organization context is validated
- ✅ No endpoints expose sensitive data without auth

### Check PII Handling
- ✅ PII is redacted in logs
- ✅ Sensitive headers are redacted
- ✅ No PII in error messages

### Check Error Messages
- ✅ Error messages don't expose internal details
- ✅ Stack traces are not returned to client
- ✅ Database errors are wrapped in domain errors

---

## 13. Performance Checks

### Check Database Queries
- ✅ Upsert operation is efficient (single query)
- ✅ No N+1 queries
- ✅ Proper indexes on `clerk_org_id` (unique constraint)

### Check Response Times
```bash
# Use curl with timing
curl -w "@curl-format.txt" -X POST http://localhost:3000/api/orgs/create \
  -H "Authorization: Bearer <clerk_session_token>" \
  -H "Content-Type: application/json" \
  -d '{}'
```

**Expected**: Response time < 500ms for database operations.

---

## 14. Acceptance Criteria Verification

### Baseline 5

- [ ] **Test 1**: Returns 200 with `{data: {orgId}, correlationId}` on valid input
- [ ] **Test 2**: Requires/auto-generates `x-request-id` and `x-correlation-id`
- [ ] **Test 3**: Rejects unauthenticated requests with 401
- [ ] **Test 4**: Validates payload, returns 400 with envelope error format on violation
- [ ] **Test 5**: Duplicate `request_id` returns identical body (idempotency)

### Situational

- [ ] **Test 1**: Returns 403 when authenticated user lacks Clerk org context
- [ ] **Test 2**: Duplicate `clerkOrgId` returns same `orgId` (idempotent upsert)
- [ ] **Test 3**: Logs redact PII (email, name, tokens)

---

## 15. Deployment Readiness

### Pre-Deployment Checklist
- [ ] All tests pass
- [ ] No linter errors
- [ ] No TypeScript errors
- [ ] Database migrations applied
- [ ] Environment variables configured
- [ ] Manual testing completed
- [ ] Documentation reviewed
- [ ] Security review completed
- [ ] Performance acceptable

### Deployment Steps
1. Merge feature branch to main
2. Run CI/CD pipeline
3. Deploy to staging environment
4. Run smoke tests on staging
5. Deploy to production
6. Monitor logs and metrics
7. Verify endpoint is accessible

---

## 16. Rollback Plan

If issues are discovered in production:

### Immediate Rollback
```bash
# Revert deployment
git revert <commit-hash>
git push origin main
```

### Database Rollback
```sql
-- Delete organizations created during this deployment
DELETE FROM organizations WHERE created_at > '<deployment_timestamp>';
```

### Monitoring
- Check error rates in logs
- Monitor response times
- Check database connection pool
- Verify Clerk authentication is working

---

## 17. Post-Deployment Verification

### Check Production Logs
```bash
# Check for errors
grep "ERROR" logs/production.log | tail -20

# Check for successful requests
grep "Organization created successfully" logs/production.log | tail -10
```

### Check Production Database
```sql
-- Verify organizations are being created
SELECT COUNT(*) FROM organizations WHERE created_at > NOW() - INTERVAL '1 hour';
```

### Check Metrics
- Response time p50, p95, p99
- Error rate
- Request rate
- Database connection pool usage

---

## Summary

✅ **All checks passed**: Ready for deployment
⚠️ **Some checks failed**: Review and fix issues before deployment
❌ **Critical issues found**: Do not deploy

---

## Support

If you encounter issues during verification:

1. Check the implementation summary: `docs/implementation/story-1.1.summary.md`
2. Review the quick reference: `docs/implementation/story-1.1.quick-reference.md`
3. Check test files for examples: `tests/integration/api/orgs-create.test.ts`
4. Review error logs for specific error messages
5. Consult the API documentation: `docs/api.md`

---

**Implementation Date**: October 20, 2025
**Story**: UC-01 Step 1.1 - Create Organization Endpoint
**Status**: ✅ Implementation Complete - Awaiting Verification

